# nmap命令

## 主机发现

|功能|命令|
|---|---|
|扫描单个主机     | `nmap -sn 192.168.1.1` |
|扫描网段内所有主机| `nmap -sn 192.168.1.0/24` |
|扫描某几个IP     | `nmap -sn 192.168.1.1 192.168.1.5 192.168.1.10` |
|扫描某个IP范围   | `nmap -sn 192.168.1.1-20` |

事实上， `-sn` 参数的意思就是只发现主机，不进行端口扫描，从而节省时间（但不意味着不访问端口了。nmap的主机发现有多种探测方式，如果主机发现过程中，对方主机没有回复ICMP数据报，nmap会进行TCP SYN和ACK探测，这就会访问端口）

加上 `-n` 参数，则不会进行域名解析，加速扫描： `nmap -sn -n 192.168.1.0/24`

## 端口扫描

|功能|命令|
|---|---|
|扫描常用端口         | `nmap 192.168.1.1` |
|扫描极常用端口（更少）| `nmap -F 192.168.1.1` |
|扫描所有端口         | `nmap -p- 192.168.1.1` |
|扫描某几个端口       | `nmap -p 80,443 192.168.1.1` |
|扫描某个端口范围     | `nmap -p 1-1000 192.168.1.1` |

参数 `-sT` 指定使用TCP Connect扫描， `-sS` 指定使用TCP SYN扫描， `-sU` 指定使用UDP扫描，默认是TCP Connect扫描

只有TCP Connect扫描不需要root权限，因为它进行完整的三次握手，只需使用操作系统的TCP系统调用；而TCP SYN扫描发送SYN包后，收到SYN-ACK后直接发送RST包中止TCP连接，这需要手动构造SYN包，而这只有root能做到。由于TCP SYN扫描不是完整的三次握手，因此不容易被日志记录，扫描行为更加隐蔽

而由于UDP是无连接的，目标主机本来就不会响应普通UDP数据包，想要使用UDP扫描，必须构造特殊的数据包“诱导”对方回应，比如发送一个伪造的DNS查询，所以不能直接使用系统调用，也必须要有root权限

* 使用UDP扫描： `sudo nmap -p- -sU 192.168.1.1`
* 使用SYN扫描： `sudo nmap -p- -sS 192.168.1.1`

注意：端口扫描的结果中，SERVICE列中显示的是该端口的默认服务，比如22端口上一般都是ssh服务，所以nmap扫到22端口活动时，直接注明了ssh，但其实也有可能是其他服务。如果将mysql服务监听在22端口，只使用nmap命令仍然会显示SERVICE为ssh，这时可以通过-sV参数进行服务识别

## 服务识别

用于检测对应端口上运行的服务

检测常用端口上的服务 `nmap -sV 192.168.1.1`

nmap会尝试各种协议来确定该端口到底运行了什么服务，因此运行该命令会消耗大量时间，建议先使用端口扫描来确定端口，然后通过 `-p` 参数针对某一特定端口进行服务识别

指定端口的方法与端口扫描部分的命令格式相同

## 操作系统检测

用于检测对应IP地址所运行的操作系统： `nmap -O 192.168.1.1`

操作系统的判断依据仍然是端口扫描结果，所以也可以通过 `-p` 等限制只扫描某几个端口

如果目标主机禁ping，则需要使用 `-Pn` 参数，不进行主机发现，直接扫描和判断

## 从文件读取扫描目标

target.txt文件示例：

```txt
192.168.1.1
192.168.1.2
192.168.2.0/24
example.com
```

然后执行： `nmap -iL targets.txt`

也可以加其他参数，如 `nmap -sS -sV -iL targets.txt`
